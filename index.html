<html>

<head>
  <title>Calling a Web API as a user authenticated with Msal.js app</title>
  <style>
    .hidden {
      visibility: hidden
    }

    .visible {
      visibility: visible
    }

    .response {
      border: solid;
      border-width: thin;
      background-color: azure;
      padding: 2px;
    }
  </style>
</head>

<body>
  <!-- bluebird only needed if this page needs to run on Internet Explorer -->
  <!-- msal.min.js can be used in the place of msal.js; included msal.js to make debug easy -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bluebird/3.3.4/bluebird.min.js" class="pre"></script>
  <script type="text/javascript" src="https://alcdn.msauth.net/lib/1.2.1/js/msal.js" integrity="sha384-9TV1245fz+BaI+VvCjMYL0YDMElLBwNS84v3mY57pXNOt6xcUYch2QLImaTahcOP" crossorigin="anonymous"></script>
    <script type="text/javascript">
        if(typeof Msal === 'undefined')document.write(unescape("%3Cscript src='https://alcdn.msftauth.net/lib/1.2.1/js/msal.js' type='text/javascript' integrity='sha384-9TV1245fz+BaI+VvCjMYL0YDMElLBwNS84v3mY57pXNOt6xcUYch2QLImaTahcOP' crossorigin='anonymous'%3E%3C/script%3E"));
    </script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" class="pre"></script>

  <h2>Getting an access token with Azure AD B2C and calling a Web API</h2>
  <div>
    <div id="label">Sign-in with Microsoft Azure AD B2C</div>
    <button id="auth" onclick="refreshToken('123')">Login</button>
    <button id="callApiButton" class="hidden" onclick="callApi()">Call Web API</button>	
	
	<button id="t123" class="hidden tbtn" data-tid="123" onclick="refreshToken('123')">Tenant 123</button>
	<button id="t456" class="hidden tbtn" data-tid="456" onclick="refreshToken('456')">Tenant 456</button>
	
	<button id="t789" class="hidden tbtn" data-tid="789" onclick="refreshToken('789')">Tenant 789</button>
  </div>

  <pre class="response"></pre>

  <script class="pre">

    // The current application coordinates were pre-registered in a B2C tenant.
    var appConfig = {
      b2cScopes: ["https://sgsmcs.onmicrosoft.com/smcsapi/smcs.read"],
      webApi: "https://smcs-demo-b2c-api.azurewebsites.net/hello" //"http://localhost:5000/hello"
    };

  </script>

  <script>
    "use strict";

    // configuration to initialize msal
    const msalConfig = {
        auth: {
            clientId: "05f85b6f-7742-4473-86dd-a45f76157aff", //This is your client ID
            authority: "https://sgsmcs.b2clogin.com/sgsmcs.onmicrosoft.com/B2C_1A_signup_signin", //This is your tenant info
            validateAuthority: false
        },
        cache: {
            cacheLocation: "localStorage",
            storeAuthStateInCookie: true
        }
    };

    // instantiate MSAL
    const myMSALObj = new Msal.UserAgentApplication(msalConfig);

    // request to signin - returns an idToken
    <!-- const loginRequest = { -->
        <!-- scopes: appConfig.b2cScopes, -->
		<!-- extraQueryParameters: { 'smcsTenantId': "123"} -->
    <!-- }; -->

    // request to acquire a token for resource access
    const tokenRequest = {
        scopes: appConfig.b2cScopes
    };

    // signin and acquire a token silently with POPUP flow. Fall back in case of failure with silent acquisition to popup
    function signIn(tenantId) {
		var loginRequest = {
			scopes: appConfig.b2cScopes,
			extraQueryParameters: { 'smcsTenantIdParam': tenantId}
		};
        myMSALObj.loginPopup(loginRequest).then(function (loginResponse) {
            getToken(tokenRequest).then(updateUI);
        }).catch(function (error) {
            logMessage(error);
        });
    }
	
	<!-- function authCallback(error, response) { -->
		<!-- logMessage('authCallback', response); -->
		<!-- var tenantId = myMSALObj.getAccount().idTokenClaims.smcsTenantId; -->
		<!-- var accessTokenRequest = { -->
			<!-- scopes: appConfig.b2cScopes, -->
			<!-- extraQueryParameters: { 'smcsTenantIdParam': tenantId}, -->
			<!-- forceRefresh: true -->
		<!-- }; -->
		
		<!-- getToken(accessTokenRequest).then(updateUI).catch(function (error) { -->
            <!-- logMessage(error); -->
        <!-- }); -->
	<!-- } -->

	<!-- myMSALObj.handleRedirectCallback(authCallback); -->

	
	function refreshToken(tenantId) {
		var accessTokenRequest = {
			scopes: appConfig.b2cScopes,
			extraQueryParameters: { 'smcsTenantIdParam': tenantId},
			forceRefresh: true
		};
		
		<!-- myMSALObj.loginRedirect(accessTokenRequest); -->
		
		
        myMSALObj.loginPopup(accessTokenRequest).then(function (loginResponse) {
            getToken(accessTokenRequest).then(updateUI);
        }).catch(function (error) {
            logMessage(error);
        });
    }
		
		<!-- myMSALObj.acquireTokenRedirect(accessTokenRequest).then(function (loginResponse) { -->
            <!-- getToken(accessTokenRequest).then(updateUI) -->
        <!-- }).catch(function (error) { -->
            <!-- logMessage(error); -->
        <!-- }); -->
    <!-- } -->
	
	

    //acquire a token silently
    function getToken(tokenRequest) {
        return myMSALObj.acquireTokenSilent(tokenRequest).catch(function(error) {
          console.log("aquire token popup");
          // fallback to interaction when silent call fails
          return myMSALObj.acquireTokenPopup(tokenRequest).then(function (tokenResponse) {
          }).catch(function(error){
            logMessage("Failed token acquisition", error);
        });
      });
    }

    // updates the UI post login/token acqusition
    function updateUI() {
		console.log(myMSALObj);
      const userName = myMSALObj.getAccount().name;
      console.log(myMSALObj.getAccount());
	  var tenantId = myMSALObj.getAccount().idTokenClaims.smcsTenantId;
	  var applicationRoles = myMSALObj.getAccount().idTokenClaims.roles;
	  var smcsRole = myMSALObj.getAccount().idTokenClaims.smcsRole;
	  console.log('tenantId', tenantId);
	  
      logMessage("User '" + userName + "' logged-in")
	  logMessage("Tenant ID: '" + tenantId + "'")
	  logMessage("Application roles: '" + applicationRoles + "'");	  
	  logMessage("Project roles: '" + smcsRole + "'");	  
	  

      // add the logout button
      const authButton = document.getElementById('auth');
      authButton.innerHTML = 'logout';
      authButton.setAttribute('onclick', 'logout();');

      // greet the user - specifying login
      const label = document.getElementById('label');
      label.innerText = "Hello " + userName;

      // add the callWebApi button
      const callWebApiButton = document.getElementById('callApiButton');
      callWebApiButton.setAttribute('class', 'visible');
	  
	  const tbtns = document.getElementsByClassName('tbtn'); 
	  for(var i=0;i<tbtns.length;i++){ 
		tbtns[i].classList.remove('hidden'); 
		if(tbtns[i].dataset.tid == tenantId){ 
			 tbtns[i].setAttribute('disabled', 'disabled'); 
		}else{ 
			tbtns[i].removeAttribute('disabled');
		} 
	  } 
	  
    }

    // calls the resource API with the token
    function callApi() {
      getToken(tokenRequest).then(function(tokenResponse) {
        callApiWithAccessToken(tokenResponse.accessToken);
      });
    }

    // helper function to access the resource with the token
    function callApiWithAccessToken(accessToken) {
      // Call the Web API with the AccessToken
	  logMessage("Calling Web API...");
      $.ajax({
        type: "GET",
        url: appConfig.webApi,
        headers: {
          'Authorization': 'Bearer ' + accessToken,
        },
      }).done(function (data) {
        logMessage("Web APi returned:\n" + JSON.stringify(data));
      })
        .fail(function (jqXHR, textStatus) {
          logMessage("Error calling the Web api:\n" + textStatus);
        })
    }

    // signout the user
    function logout() {
      // Removes all sessions, need to call AAD endpoint to do full logout
      myMSALObj.logout();
    }

    // debug helper
    function logMessage(s) {
      document.body.querySelector('.response').appendChild(document.createTextNode('\n' + s));
    }


	const accessTokenRequest = {

	scopes: appConfig.b2cScopes,
};



  </script>
</body>

</html>
